// Assign propellant types
@PART:HAS[@MODULE:HAS[#chemTechEngineType[hydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = propellant
}
@PART:HAS[@MODULE:HAS[#chemTechEngineType[monopropellant]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = propellant
}
@PART:HAS[#chemTechTankType[cryogenic]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = propellant
}
@PART:HAS[#chemTechTankType[monopropellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = propellant
}
@PART:HAS[@MODULE:HAS[#chemTechEngineType[bipropellant*]],~chemTechFuelMixerPropellantType[propellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = fuel
}
@PART:HAS[@MODULE:HAS[#chemTechEngineType[bipropellant*]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = oxidizer
}
@PART:HAS[@MODULE:HAS[#chemTechEngineType[jet*]],~chemTechFuelMixerPropellantType[propellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = fuel
}
@PART:HAS[@MODULE:HAS[#chemTechEngineType[jet*]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = intakeAir
}
@PART:HAS[#chemTechTankType[bipropellant],~chemTechFuelMixerPropellantType[propellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = fuel
}
@PART:HAS[#chemTechTankType[bipropellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = oxidizer
}
@PART:HAS[#chemTechTankType[aviation],~chemTechFuelMixerPropellantType[propellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = fuel
}
@PART:HAS[#chemTechTankType[aviation]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechFuelMixerPropellantType = oxidizer
}

// Create FuelMixer modules
@PART:HAS[#chemTechFuelMixerPropellantType[propellant]]:BEFORE[zzz_ChemicalPropulsion]
{
	MODULE
	{
		name = ModuleFuelMixerPropellant
		moduleID = chemTechFuelMixerPropellant
		drawStackGauge = true
	}
}
@PART:HAS[#chemTechFuelMixerPropellantType[fuel]]:BEFORE[zzz_ChemicalPropulsion]
{
	MODULE
	{
		name = ModuleFuelMixerPropellant
		moduleID = chemTechFuelMixerFuel
		drawStackGauge = true
	}
}
@PART:HAS[#chemTechFuelMixerPropellantType[oxidizer]]:BEFORE[zzz_ChemicalPropulsion]
{
	MODULE
	{
		name = ModuleFuelMixerPropellant
		moduleID = chemTechFuelMixerOxidizer
	}
}
@PART:HAS[#chemTechFuelMixerPropellantType[intakeAir]]:BEFORE[zzz_ChemicalPropulsion]
{
	MODULE
	{
		name = ModuleFuelMixerPropellant
		moduleID = chemTechFuelMixerIntakeAir
		resourceName = IntakeAir
		ignoreForIsp = true
	}
}

// Set propellant ratios for jet engines
@PART:HAS[@MODULE:HAS[#chemTechEngineType[jetKerosene]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixerFuel]]
	{
		ratio = #$../MODULE[ModuleEngines*]:HAS[@PROPELLANT[Kerosene],@PROPELLANT[IntakeAir]]/PROPELLANT[Kerosene]/ratio$
	}
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixerIntakeAir]]
	{
		ratio = #$../MODULE[ModuleEngines*]:HAS[@PROPELLANT[Kerosene],@PROPELLANT[IntakeAir]]/PROPELLANT[IntakeAir]/ratio$
	}
}
@PART:HAS[@MODULE:HAS[#chemTechEngineType[jetHydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixerFuel]]
	{
		ratio = #$../MODULE[ModuleEngines*]:HAS[@PROPELLANT[LqdHydrogen],@PROPELLANT[IntakeAir]]/PROPELLANT[LqdHydrogen]/ratio$
	}
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixerIntakeAir]]
	{
		ratio = #$../MODULE[ModuleEngines*]:HAS[@PROPELLANT[LqdHydrogen],@PROPELLANT[IntakeAir]]/PROPELLANT[IntakeAir]/ratio$
	}
}

// Assign engineIDs if available
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[hydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixerPropellant]]
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[hydrogen]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[monopropellant]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixerPropellant]]
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[monopropellant]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[jetKerosene]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[jetKerosene]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[jetHydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[jetHydrogen]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[bipropellantAmmonilox]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*],~moduleID[chemTechFuelMixerIntakeAir]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[bipropellantAmmonilox]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[bipropellantKeroxide]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*],~moduleID[chemTechFuelMixerIntakeAir]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[bipropellantKeroxide]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[bipropellantHypergolic]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*],~moduleID[chemTechFuelMixerIntakeAir]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[bipropellantHypergolic]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[bipropellantKerolox]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*],~moduleID[chemTechFuelMixerIntakeAir]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[bipropellantKerolox]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[bipropellantMethalox]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*],~moduleID[chemTechFuelMixerIntakeAir]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[bipropellantMethalox]]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#engineID,#chemTechEngineType[bipropellantHydrolox]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant]:HAS[#moduleID[chemTechFuelMixer*],~moduleID[chemTechFuelMixerIntakeAir]],*
	{
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechEngineType[bipropellantHydrolox]]/engineID$
	}
}

// Prevent FuelMixer from targeting built-in engines on tanks which use a different propellant, e.g. solid fuel separators on external bipropellant tanks
@PART:HAS[#chemTechTankType[bipropellant],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant],*
	{
		engineID = none
	}
}
@PART:HAS[#chemTechTankType[aviation],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant],*
	{
		engineID = none
	}
}
@PART:HAS[#chemTechTankType[cryogenic],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[LqdHydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant],*
	{
		engineID = none
	}
}
@PART:HAS[#chemTechTankType[monopropellant],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[MonoPropellant]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleFuelMixerPropellant],*
	{
		engineID = none
	}
}